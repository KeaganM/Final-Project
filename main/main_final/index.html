<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Austin Urban Development</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.9/esri/css/main.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" href="style.css">-->
<script src="https://js.arcgis.com/4.9/"></script>
<style>

html, body, #viewDiv {
   padding: 0;
   margin: 0;
   height: 100%;
   width: 100%;

 }

 #body {
   opacity:0.5;
 }

#viewDiv {
 position:relative;
}

#mydiv {
   position: absolute;
   z-index: 9;
   background-color: #3A3838;
   text-align: center;
   border: 6px solid #0E6661;
   border-style:double;
   top: 3%;
   left: 8%;
   height: 30%;
   width:300px;
   opacity: 0.9;
}

#mydivheader {
   padding: 10px;
   cursor: move;
   z-index: 10;
   background-color: #0E6661;
   color: #fff;
}


#date_one {
  position:absolute;
  width:20%;
  top:65%;
  left:25%;

}

#date_two {
  position:absolute;
  width:20%;
  top:65%;
  left:50%;

}

#fields {
  position:absolute;
  width:95%;
  top: 28%;
  right: 2%;
}

#variableselector{
  text-align: center;
  left: 15%;
  color:white;
}

#hidewindow {
   position:absolute;
   right: 1%;
   top:1px;
}

#htmlslider {
  position: relative:
  bottom: 30%;
  width:80%;
}

#amountofchange {
  position: absolute;
  top: 45%;
  left: 28%;
  color: white;
}

#amountofchange #year1  {
  position: absolute;
  top: 55%;;
  font-size: 12px;
}

#amountofchange #year2  {
  position: absolute;
  top: 55%;
  left: 60%;
  font-size: 12px;
}

#amountofchange #explain {
  position: absolute;
  font-size: 10px;
  top: 150%;
}

#changebutton {
  position: absolute;
  bottom: 5%;
  left: 37%;
}

#slidervalue {
  color:white;
}

.loader {
    border: 16px solid #f3f3f3; /* Light grey */
    border-top: 16px solid #3498db; /* Blue */
    border-radius: 50%;
    width: 120px;
    height: 120px;
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#opacitybutton{
  position: absolute;
  bottom: 10%;
}


</style>
</head>
<div id = "body">
<body>
  <div class = "loader"></div>
 <div id="mydiv">
   <button id = "hidewindow" type = "btn"><i class = "fa fa-window-minimize"></i></button>
  <div id="mydivheader">Analysis Tab</div>
  <div id= "variableselector"><p>Variable Changer </p></div>
  <select id = "fields">
  	<option value = "F2000b_col_">Number of Blue Collar Workers</option>
  	<option value = "F2000per_ed">Precent of people with < Highschool</option>
 	<option value = "F2000med_ag"> Median Age</option>
  	<option value = "F2000med_in">Median Income</option>
    	<option value = "F2000num_po">Number of Population</option>
      	<option value = "F2000num_fa">Number of Family Population</option>
        	<option value = "F2000w_colo_">Number of White Collar Workers</option>
  </select>
  <div id = "amountofchange">
  <p id = "amount">Amount of Change</p>
  <p id = "year1">Year 1</p>
  <p id = "year2"> Year 2</p>
  <p id = "explain"> (Year 2 - Year 1/Year1 ) * 100 = Amount of Change</p>
  </div>
  <select id = "date_one">
    <option value = "0">2000</option>
    <option value = "1">2010</option>
  </select>
  <select id = "date_two">
    <option value = "0">2000</option>
    <option value = "1">2010</option>
  </select>
  <div>
    <button id = "changebutton" type = "button">Analyze!</button>
    <button id = "opacitybutton" type = "button" onclick = "loaderTimeout">Analyze!</button>
  </div>
  <div id = "slider" class = "slidercontainer">
  	<br><input autocomplete = "off" id = "htmlslider" type = "range" min = "0" max = "1" step = "1"  value ="0" class = "slider" onchange = "updateSliderValue()" >  <!-- autocomplete resets the slider position -->
  <span id = "slidervalue">2000</span>
</div>
  </div>
<script>

//***** Basic Variables *****
  var map = [];
  var view = [];
  var basemapGalley = [];
  var compass = [];
  var home = [];
  var scalebar = [];
  var bgExpand = [];
  var searchwidget = [];
  var variable_choices = [[],[]];
  var field_labels = ["Number of Blue Collar Workers",
  "Percent of Population with < Highschool Education",
  "Median Age","Median Income","Number of Total Population",
  "Number of Family Population","Number of White Collar Workers"]

//***** Layer Variables *****
  var master_layer = [];
  var rendered_layers = [[],[]];
  var per_change = [];
  var per_colors = ["blue","green","yellow","orange","red","purple"];
  popUrl = "https://services9.arcgis.com/6UFiRNGaGhS09LMr/arcgis/rest/services/combined_years_2000_to_2010/FeatureServer/0";
  var params = [];
  var renders = [[],[]];
  var field_number_value;
  var popuptemp = [[],[]];
  var popuptemp2 = [];

//***** Query/Popup Variables *****
  //var popUrl = "https://services9.arcgis.com/6UFiRNGaGhS09LMr/arcgis/rest/services/2010_austin_census_tract_pop/FeatureServer/0";
  var popupTemplate = {
    title: "{title}",
    content: [{
      type:"fields",
      fieldInfos: [{
        fieldName: "F2000b_col_",
        label: "Blue Collar Workers",
        visible: true
      },{
        fieldName: "F2000per_ed",
        label: "Education < Highschool",
        visible: true
      },{
        fieldName: "F2000med_ag",
        label: "Median age",
        visible: true
      },{
        fieldName: "F2000med_in",
        label: "Median income",
        visible: true
      },{
        fieldName: "F2000num_po",
        label: "Number of Population",
        visible: true
      },{
        fieldName: "F2000num_fa",
        label: "Family Population",
        visible: true
      },{
        fieldName: "F2000w_col_",
        label: "White Collar Workers",
        visible: true
      }]
    }]
  };

/*  function fillPopups(){
      var i;
      var j;
      for (i = 0; i <2;i++){
        for (j = 0; j<7; j++){
          popupTemplate = {
            title: "{title}",
            content: [{
              type:"fields",
              fieldInfos: [{
                fieldName: variable_choices[i][j],
                label: field_labels[j],
                visible: true
              }]
            }]
          }
        }
      }
    }

    fillPopups();


*/





//***** Event Variables *****
  var dropdownchange = document.getElementById("fields");
  var dropdownvalue = fields.value;
    var dropdowndate1 = document.getElementById("date_one");
      var dropdowndatevalue1 = date_one.value;
      var dropdowndate2 = document.getElementById("date_two");
        var dropdowndatevalue2 = date_two.value;
  var slider = document.getElementById("htmlslider");
  var slidervalue = htmlslider.value;
  var analyzebutton = document.getElementById("changebutton");






  function updateSliderValue(){
  	slidervalue = htmlslider.value;
  	if (slidervalue == 0){
  		document.getElementById("slidervalue").innerHTML = 2000;
  	}else {
  		document.getElementById("slidervalue").innerHTML = 2010;
  	}
  }

  function loaderTimeout(){
    document.getElementById("body").style.opacity = 1.0;
  }



  function fillVariableArray(){
    var i;
    var j;
    var new_field_names = ["b_col_","per_ed","med_ag","med_in","num_po","num_fa","w_col_"];
    var date  = [2000,2010];
    for (i=0;i<2;i++){
      for(j=0;j<7;j++){
        variable_choices[i][j] = "F"+date[i]+new_field_names[j];
      }
    }
  }

fillVariableArray();


require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/FeatureLayer",
 "esri/widgets/BasemapGallery",
  //"esri/tasks/QueryTask",
  //"esri/tasks/support/Query",
  //"dojo/_base/array",
  //"dojo/dom",
  //"dojo/on",
  //"dojo/domReady!",
  "esri/widgets/Expand",
  "esri/widgets/Compass",
  "esri/widgets/Home",
  "esri/widgets/ScaleBar",
  "esri/widgets/Search",
 "esri/widgets/Legend",
  "esri/widgets/Print",
//  "esri/renderers/smartMapping/creators/univariateColorSize",
//  "esri/renderers/smartMapping/statistics/histogram",
//  "esri/widgets/UnivariateColorSizeSlider",
//  "esri/core/lang",
  "esri/renderers/smartMapping/statistics/classBreaks",
  "esri/renderers/ClassBreaksRenderer",
  "esri/renderers/smartMapping/creators/color"
  //"esri/layers/GraphicsLayer",
], function(
	Map,
	MapView,
	FeatureLayer,
	BasemapGallery,
  //GraphicsLayer,
  //QueryTask,
  //Query,
  //arrayUtils,
  //dom,
  //on,
	Expand,
	Compass,
	Home,
	ScaleBar,
	Search,
	Legend,
  Print,
//  colorAndSizeRendererCreator,
//  histogram,
//  UnivariateColorSizeSlider,
  //esriLang,
  classBreaks,
  ClassBreaksRenderer,
  colorRendererCreator
  ){

      master_layer = new FeatureLayer({
        url: popUrl,
        popupTemplate: popupTemplate
      });


    function createRenderedLayers(){
      var i;
      var j;

      for (i = 0;i<2;i++){
        for(j=0;j<7;j++){
          rendered_layers[i][j] = new FeatureLayer({
            url:popUrl,
          });
        }
      }
    }

    function createRenders(){
      var i;
      var j;
      for (i = 0; i < 2;i++){
        for (j = 0; j <7;j++){
          renders[i][j] = {
          layer: rendered_layers[i][j],
          field: variable_choices[i][j],
          basemap: map.basemap,
          classificationMethod: "natural-breaks", // -------------- keep this for normal layers
          numClasses: 5,
          legendOptions: {
          title: field_labels[j]
          }
        };
      }
    }
}

//**** Create a new Map and MapView instance *****
  map = new Map({
    basemap: "dark-gray",
    layers: master_layer
	});

  view = new MapView({
    container: "viewDiv",
    map: map,
    zoom: 10,
    center: [-97.7431, 30.2672],
    highlightOptions:{color:"orange"}
	});


function pushRendering(layer,renders){
  colorRendererCreator.createClassBreaksRenderer(renders)
  .then(function(response){
    layer.renderer=response.renderer;
  });
}

function pushRenderIntoLayers(){
  var i;
  var j;
  for (i = 0;i<2;i++){
    for (j = 0; j<7; j++){
        pushRendering(rendered_layers[i][j],renders[i][j])
    }

  }
}

function addMaps(){
  var i;
  var j;
  for (i = 0;i<2;i++){
    for (j = 0; j<7; j++){
      map.add(rendered_layers[i][j]);
    }
  }
}

  createRenderedLayers();
    createRenders();
pushRenderIntoLayers();
addMaps();

//*****Search Widget**********************************************************
  searchwidget = new Search({
  	view: view
	});

  view.ui.add(searchwidget, {
  	position: "top-right"
	});
//***** Print Widget *****
var print = new Print({
  view: view,
  printServiceUrl: "https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task"
});

var pbgExpand = new Expand({
view: view,
content: print
});

view.ui.add(pbgExpand, "top-right");

//*****BasemapGallery Widget*****
  basemapGallery= new BasemapGallery({
  	view: view,
  	container: document.createElement("div")
  	});

  bgExpand = new Expand({
  	view:view,
  	content: basemapGallery
  	});

  view.ui.add(bgExpand,"top-right");

//*****Compass Widget*****
    compass = new Compass({
    	view: view
  	});

    view.ui.add(compass, "top-left");

//*****Home Widget*****
     home = new Home({
     	view:view
     	});

     view.ui.add(home,"top-left");

 //*****ScaleBar Widget*****
      scaleBar = new ScaleBar({
      	view: view
      	});

      view.ui.add(scaleBar, {
      	position: "bottom-left"
    	});


 //***** Legend Widget *****
 var legend = new Legend({
  view: view,
});

var lbgExpand = new Expand({
view: view,
content: legend
});

view.ui.add(lbgExpand, "bottom-right");


  function removeVisible() {
    var i;
    var j;
    for(i=0;i<2;i++){ // -----------------------------------create global variables for the cols and rows
      for(j=0;j<7;j++){
          rendered_layers[i][j].visible = false;
      }
    }
  }

function pullLayerForward(year, data) {
  removeVisible();
  rendered_layers[year][data].visible = true;
}



function displayIndividualLayers() {
  dropdownvalue = fields.value;
  slidervalue = htmlslider.value;
  if(dropdownvalue == "F2000b_col_"){
    if(slidervalue == 0){ pullLayerForward(0,0); field_number_value = 0; } else {pullLayerForward(1,0);field_number_value = 0;}
  }else if (dropdownvalue == "F2000per_ed"){
    if(slidervalue == 0){ pullLayerForward(0,1);field_number_value = 1;} else {pullLayerForward(1,1);field_number_value = 1;}
  }else if (dropdownvalue == "F2000med_ag"){
    if(slidervalue == 0){ pullLayerForward(0,2);field_number_value = 2;} else {pullLayerForward(1,2);field_number_value = 2;}
  }else if (dropdownvalue == "F2000med_in"){
    if(slidervalue == 0){ pullLayerForward(0,3);field_number_value = 3;} else {pullLayerForward(1,3);field_number_value = 3;}
  }else if (dropdownvalue == "F2000num_po"){
    if(slidervalue == 0){ pullLayerForward(0,4);field_number_value = 4;} else {pullLayerForward(1,4);field_number_value = 4;}
  }else if (dropdownvalue == "F2000num_fa"){
    if(slidervalue == 0){ pullLayerForward(0,5);field_number_value = 5;} else {pullLayerForward(1,5);field_number_value = 5;}
  }else{
    if(slidervalue == 0){ pullLayerForward(0,6);field_number_value = 6;} else {pullLayerForward(1,6);field_number_value = 6;}
  }
}


function fillSymbol(type,colors,style,outline_color){
  var i;
  for (i =0;i<6;i++){
    per_change[i] = {
      type: type,
      color: colors[i],
      style:style,
      outline: {
        width: 0.5,
        color:outline_color
      }
    };
  }
}

fillSymbol("simple-fill",per_colors,"solid","black");

var per_change_render = [];

function renderChange(expression){
  per_change_render = {
  type:"class-breaks",
  valueExpression:expression, // ------------make sure you use "F" at the beginning
  defaultSymbol: {
        type: "simple-fill", // autocasts as new SimpleFillSymbol()
        color: "gray",
        outline: {
          width: 0.5,
          color: "white"
        }
      },
      defaultLabel: "no data",
      classBreakInfos: [
          {
                minValue: -500,
                maxValue: 0,
                symbol: per_change[0],
                label: "-100% - 0%"
          },{
            minValue: 0,
            maxValue: 20,
            symbol: per_change[1],
            label: "0% - 20%"
          },{
            minValue: 20,
            maxValue: 40,
            symbol: per_change[2],
            label: "20% - 40%"
          },{
            minValue: 40,
            maxValue: 60,
            symbol: per_change[3],
            label: "40% - 60%"
          },{
            minValue: 60,
            maxValue: 80,
            symbol: per_change[4],
            label: "60% - 80%"
          },{
            minValue: 80,
            maxValue: 100,
            symbol: per_change[5],
            label: "80% - 100%"
          }]
        };
}


function createExpression(year_two,year_one){
  return "(($feature."+year_two+" - $feature."+year_one+")/$feature."+year_one+")*100";
}

function runAnalyze (){

  removeVisible();
  dropdowndatevalue1 = date_one.value;
  dropdowndatevalue2 = date_two.value;
  renderChange(createExpression(variable_choices[dropdowndatevalue2][field_number_value],variable_choices[dropdowndatevalue1][field_number_value]));
  master_layer.renderer = per_change_render

}


function destroyChangeLayer(){

}

function hearEvents(){
  dropdownchange.addEventListener("change", displayIndividualLayers);
  slider.addEventListener("change", displayIndividualLayers);
  analyzebutton.addEventListener("click",runAnalyze);
}

hearEvents();

  /* working natural color renderer

  var master_layer = new FeatureLayer({
    url: "https://services9.arcgis.com/6UFiRNGaGhS09LMr/arcgis/rest/services/combined_years_2000_to_2010/FeatureServer/0",

  });

map.add(master_layer);


          var params = {
    layer: master_layer,
    field: "F2000med_ag",
    basemap: map.basemap,
    classificationMethod: "natural-breaks",
    numClasses: 5,
    legendOptions: {
      title: "% population with a college degree"
    }
  };

  // generate the renderer and set it on the layer
  colorRendererCreator.createClassBreaksRenderer(params)
    .then(function(response){
      master_layer.renderer = response.renderer;
    });
  */

});

/* Resources:
 * 	basemapGallery widget: https://developers.arcgis.com/javascript/latest/sample-code/sandbox/index.html?sample=widgets-expand
 * 	draggable div element: https://www.w3schools.com/howto/howto_js_draggable.asp
 * possible hotspot analysis: http://proceedings.esri.com/library/userconf/unic16/papers/un_19.pdf
 *Arcade:
        https://www.esri.com/arcgis-blog/products/arcgis-online/mapping/try-arcade-expression/
 *      https://developers.arcgis.com/arcade/playground/

 class breaks: https://developers.arcgis.com/javascript/latest/api-reference/esri-renderers-smartMapping-statistics-classBreaks.html#ClassBreaksResult
 *
 *
 *
 *
 *
 */

//***** Make a Div Element draggable *****
dragElement(document.getElementById("mydiv"));

function dragElement(elmnt) {
  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  if (document.getElementById(elmnt.id + "header")) {
    // if present, the header is where you move the DIV from:
    document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
  } else {
    // otherwise, move the DIV from anywhere inside the DIV:
    elmnt.onmousedown = dragMouseDown;
  }

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    // get the mouse cursor position at startup:
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    // set the element's new position:
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    // stop moving when mouse button is released:
    document.onmouseup = null;
    document.onmousemove = null;
  }
}
</script>
<div id="viewDiv"  ></div>
</body>
</div>
</html>
